x-redroid-common: &redroid-common
  image: ${REDROID_IMAGE:-redroid/redroid:14.0.0-latest}
  privileged: true
  mem_limit: ${MEM_LIMIT:-3g}
  cpus: ${CPU_LIMIT:-1.2}
  pids_limit: 1024
  oom_score_adj: 500
  stop_grace_period: 30s
  command:
    - androidboot.redroid_gpu_mode=guest
    - androidboot.redroid_width=${WIDTH:-480}
    - androidboot.redroid_height=${HEIGHT:-800}
    - androidboot.redroid_dpi=${DPI:-160}
  restart: "no"
  healthcheck:
    test: ["CMD-SHELL", "getprop sys.boot_completed 2>/dev/null | grep -q 1"]
    interval: 10s
    timeout: 5s
    retries: 30
    start_period: 30s
  networks:
    - hcr2-net

services:
  hcr2-0:
    <<: *redroid-common
    container_name: hcr2-0
    ports:
      - "${ADB_PORT_BASE:-5555}:5555"
    volumes:
      - hcr2-data-0:/data

  hcr2-1:
    <<: *redroid-common
    container_name: hcr2-1
    ports:
      - "5556:5555"
    volumes:
      - hcr2-data-1:/data

  hcr2-2:
    <<: *redroid-common
    container_name: hcr2-2
    profiles: ["scale-4", "scale-8"]
    ports:
      - "5557:5555"
    volumes:
      - hcr2-data-2:/data

  hcr2-3:
    <<: *redroid-common
    container_name: hcr2-3
    profiles: ["scale-4", "scale-8"]
    ports:
      - "5558:5555"
    volumes:
      - hcr2-data-3:/data

  hcr2-4:
    <<: *redroid-common
    container_name: hcr2-4
    profiles: ["scale-8"]
    ports:
      - "5559:5555"
    volumes:
      - hcr2-data-4:/data

  hcr2-5:
    <<: *redroid-common
    container_name: hcr2-5
    profiles: ["scale-8"]
    ports:
      - "5560:5555"
    volumes:
      - hcr2-data-5:/data

  hcr2-6:
    <<: *redroid-common
    container_name: hcr2-6
    profiles: ["scale-8"]
    ports:
      - "5561:5555"
    volumes:
      - hcr2-data-6:/data

  hcr2-7:
    <<: *redroid-common
    container_name: hcr2-7
    profiles: ["scale-8"]
    ports:
      - "5562:5555"
    volumes:
      - hcr2-data-7:/data

  ws-scrcpy:
    image: scavin/ws-scrcpy
    container_name: ws-scrcpy
    ports:
      - "8100:8000"
    depends_on:
      - hcr2-0
      - hcr2-1
    restart: unless-stopped
    networks:
      - hcr2-net
    labels:
      icon: https://cdn-icons-png.flaticon.com/512/545/545245.png
      casaos.name: "ws-scrcpy"
      casaos.title.en_us: "WS-Scrcpy"
      casaos.description.en_us: "Web-based screen mirroring for Android emulators"
      casaos.port.main: "8100"
      casaos.web.port: "8100"
      casaos.category: "Developer"

  dashboard:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dashboard
    container_name: hcr2-dashboard
    ports:
      - "8150:8150"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ../logs:/app/logs:ro
    depends_on:
      - hcr2-0
      - hcr2-1
    restart: unless-stopped
    networks:
      - hcr2-net
    labels:
      icon: https://cdn-icons-png.flaticon.com/512/3612/3612569.png
      casaos.name: "hcr2-dashboard"
      casaos.title.en_us: "HCR2 Dashboard"
      casaos.description.en_us: "Hill Climb Racing 2 AI training monitor & emulator control"
      casaos.port.main: "8150"
      casaos.web.port: "8150"
      casaos.category: "Developer"

networks:
  hcr2-net:
    driver: bridge

volumes:
  hcr2-data-0:
  hcr2-data-1:
  hcr2-data-2:
  hcr2-data-3:
  hcr2-data-4:
  hcr2-data-5:
  hcr2-data-6:
  hcr2-data-7:
